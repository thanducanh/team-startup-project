<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Hi·ªán Tr∆∞·ªùng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .mobile-frame { max-width: 420px; margin: 0 auto; min-height: 100vh; background: white; padding-bottom: 80px; position: relative; }
        .header { background: #007bff; color: white; padding: 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .camera-btn { width: 80px; height: 80px; background: white; border: 4px solid #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; margin: -40px auto 20px auto; position: relative; z-index: 10; }
        .preview-box { display: none; margin-top: 15px; border: 2px dashed #ddd; }
        .preview-box img { width: 100%; display: block; }
        #cameraInput { display: none; }
        .user-info { font-size: 14px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 5px; }
        .logout-btn { position: absolute; top: 15px; right: 15px; color: white; text-decoration: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="mobile-frame">
        <div class="header">
            <div class="logout-btn" onclick="logout()">üö™</div>
            <h4 class="m-0">üì∏ B√ÅO C√ÅO</h4>
            <div class="user-info">üë§ <span id="user-display">ƒêang t·∫£i...</span></div>
            <div id="gps-status" class="badge bg-warning text-dark mt-2 d-block mx-auto" style="width: fit-content;">üì° ƒêang d√≤ v·ªã tr√≠...</div>
        </div>

        <div class="p-3">
            <div class="camera-btn" onclick="document.getElementById('cameraInput').click()">üì∑</div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="uploadPhoto()">
            
            <div class="text-center">
                <div id="uploading" class="text-primary fw-bold mb-2" style="display:none;">‚è≥ ƒêang t·∫£i ·∫£nh...</div>
                <div id="preview" class="preview-box"><img id="preview-img" src=""></div>
            </div>

            <div class="mt-4">
                <label class="fw-bold mb-1">Ghi ch√∫ c√¥ng vi·ªác:</label>
                <textarea id="note" class="form-control mb-3" rows="3" placeholder="ƒê√£ xong vi·ªác..."></textarea>
                <button onclick="submitReport()" class="btn btn-success w-100 py-3 fw-bold text-uppercase">üöÄ G·ª¨I B√ÅO C√ÅO</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. KI·ªÇM TRA B·∫¢O M·∫¨T (Ch·∫°y ngay khi m·ªü trang) ---
        const token = localStorage.getItem('token');
        const userName = localStorage.getItem('user_name');

        if (!token) {
            // N·∫øu kh√¥ng c√≥ v√© -> ƒêu·ªïi v·ªÅ trang ƒëƒÉng nh·∫≠p
            window.location.href = '/login.html';
        } else {
            // N·∫øu c√≥ v√© -> Hi·ªán t√™n th·ª£
            document.getElementById('user-display').innerText = userName;
        }

        function logout() {
            if(confirm('B·∫°n mu·ªën ƒëƒÉng xu·∫•t?')) {
                localStorage.clear(); // X√≥a v√©
                window.location.href = '/login.html';
            }
        }

        // --- 2. C√ÅC CH·ª®C NƒÇNG C≈® (GPS, UPLOAD) ---
        let currentImageUrl = "";
        let currentLocation = "";

        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    currentLocation = `${pos.coords.latitude},${pos.coords.longitude}`;
                    document.getElementById('gps-status').innerHTML = "‚úÖ ƒê√£ c√≥ v·ªã tr√≠";
                    document.getElementById('gps-status').className = "badge bg-success text-white mt-2 d-block mx-auto";
                },
                () => alert("H√£y b·∫≠t GPS!")
            );
        }

        async function uploadPhoto() {
            const file = document.getElementById('cameraInput').files[0];
            if (!file) return;
            
            document.getElementById('preview').style.display = "block";
            document.getElementById('preview-img').src = URL.createObjectURL(file);
            document.getElementById('uploading').style.display = "block";

            const formData = new FormData();
            formData.append('photo', file);

            try {
                // Upload ·∫£nh kh√¥ng c·∫ßn token (cho ph√©p th·ª£ up ·∫£nh tho·∫£i m√°i)
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.url) {
                    currentImageUrl = data.url;
                    document.getElementById('uploading').innerHTML = "‚úÖ ·∫¢nh ƒë√£ l√™n m√¢y!";
                    document.getElementById('uploading').className = "text-success fw-bold mb-2";
                }
            } catch (err) { alert("L·ªói m·∫°ng: " + err.message); }
        }

        // --- 3. G·ª¨I B√ÅO C√ÅO (C√ì K√àM V√â TOKEN) ---
        async function submitReport() {
            if (!currentImageUrl) return alert("‚ö†Ô∏è Ch·ª•p ·∫£nh tr∆∞·ªõc ƒë√£!");
            if (!currentLocation) return alert("‚ö†Ô∏è ƒê·ª£i l·∫•y GPS ch√∫t...");
            
            const note = document.getElementById('note').value;

            try {
                const res = await fetch('/api/reports', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token // <--- QUAN TR·ªåNG: K·∫πp v√© v√†o ƒë√¢y
                    },
                    body: JSON.stringify({ location: currentLocation, image_url: currentImageUrl, note })
                });

                if (res.ok) { 
                    alert("üéâ B√ÅO C√ÅO TH√ÄNH C√îNG!"); 
                    window.location.reload();
                } else if (res.status === 401 || res.status === 403) {
                    alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");
                    logout();
                } else {
                    alert("L·ªói server!");
                }
            } catch (err) { alert("L·ªói m·∫°ng!"); }
        }
    </script>
</body>
</html>
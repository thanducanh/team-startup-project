<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C∆† GI·ªöI VI·ªÜT NAM | B√°o C√°o</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèóÔ∏è</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .mobile-frame { max-width: 420px; margin: 0 auto; min-height: 100vh; background: white; padding-bottom: 80px; position: relative; }
        .header { background: #007bff; color: white; padding: 20px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; }
        .camera-btn { width: 80px; height: 80px; background: white; border: 4px solid #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; margin: -40px auto 20px auto; position: relative; z-index: 10; box-shadow: 0 5px 15px rgba(0,123,255,0.3); }
        .preview-box { display: none; margin-top: 15px; border: 2px dashed #ddd; }
        .preview-box img { width: 100%; display: block; }
        #cameraInput { display: none; }
        .logout-btn { position: absolute; top: 15px; right: 15px; color: white; cursor: pointer; font-size: 20px;}
    </style>
</head>
<body>
    <div class="mobile-frame">
        <div class="header">
            <div class="logout-btn" onclick="logout()">üö™</div>
            <h5 class="m-0 fw-bold">C∆† GI·ªöI VI·ªÜT NAM</h5>
            <div class="small opacity-75">Xin ch√†o, <span id="user-name">...</span></div>
            <div id="gps-status" class="badge bg-warning text-dark mt-2">üì° ƒêang d√≤ GPS...</div>
        </div>

        <div class="p-3">
            <div class="camera-btn" onclick="document.getElementById('cameraInput').click()">üì∑</div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="uploadPhoto()">
            
            <div class="text-center">
                <div id="uploading" class="text-primary fw-bold mb-2" style="display:none;">‚è≥ ƒêang t·∫£i ·∫£nh...</div>
                <div id="preview" class="preview-box"><img id="preview-img" src=""></div>
            </div>

            <div class="mt-4">
                <label class="fw-bold mb-1">Ghi ch√∫ c√¥ng vi·ªác:</label>
                <textarea id="note" class="form-control mb-3" rows="3" placeholder="B√°o c√°o t√¨nh h√¨nh..."></textarea>
                <label class="fw-bold mb-1">Nh√¢n vi√™n:</label>
                <select id="workerSelect" class="form-select mb-4"></select>
                <button onclick="submitReport()" class="btn btn-success w-100 py-3 fw-bold">üöÄ G·ª¨I B√ÅO C√ÅO</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';
        document.getElementById('user-name').innerText = localStorage.getItem('user_name');

        function logout() { localStorage.clear(); window.location.href = '/login.html'; }

        let currentImageUrl = "", currentLocation = "";

        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    currentLocation = `${pos.coords.latitude},${pos.coords.longitude}`;
                    document.getElementById('gps-status').innerHTML = "‚úÖ ƒê√£ c√≥ v·ªã tr√≠";
                    document.getElementById('gps-status').className = "badge bg-success mt-2";
                },
                () => alert("B·∫≠t GPS l√™n anh ∆°i!")
            );
        }

        fetch('/api/workers').then(res => res.json()).then(data => {
            const select = document.getElementById('workerSelect');
            data.forEach(w => select.innerHTML += `<option value="${w.id}">${w.name}</option>`);
        });

        async function uploadPhoto() {
            const file = document.getElementById('cameraInput').files[0];
            if (!file) return;
            document.getElementById('preview').style.display = "block";
            document.getElementById('preview-img').src = URL.createObjectURL(file);
            document.getElementById('uploading').style.display = "block";

            const formData = new FormData();
            formData.append('photo', file);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.url) {
                    currentImageUrl = data.url;
                    document.getElementById('uploading').innerHTML = "‚úÖ ·∫¢nh OK!";
                    document.getElementById('uploading').className = "text-success fw-bold mb-2";
                }
            } catch (err) {}
        }

        async function submitReport() {
            if (!currentImageUrl || !currentLocation) return alert("Thi·∫øu ·∫£nh ho·∫∑c GPS!");
            const note = document.getElementById('note').value;
            const worker_id = document.getElementById('workerSelect').value;

            const res = await fetch('/api/reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ worker_id, location: currentLocation, image_url: currentImageUrl, note })
            });

            if (res.ok) { alert("B√°o c√°o th√†nh c√¥ng!"); window.location.reload(); }
            else alert("L·ªói server!");
        }
    </script>
</body>
</html>
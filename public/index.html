<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C∆† GI·ªöI VI·ªÜT NAM</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèóÔ∏è</text></svg>">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #F4F5F7; font-family: Arial, sans-serif; padding-bottom: 70px; }
        
        /* HEADER ZALO */
        .zalo-header { background: linear-gradient(90deg, #0068FF, #0043a8); color: white; padding: 15px; position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header-title { font-weight: bold; font-size: 16px; text-transform: uppercase; }
        .content-area { margin-top: 70px; padding: 10px; }

        /* CARDS STYLE */
        .zalo-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; }
        .post-avatar { width: 40px; height: 40px; background: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #0068FF; margin-right: 10px; }
        .post-name { font-weight: bold; font-size: 14px; color: #333; }
        .post-time { font-size: 11px; color: #888; }
        .post-content { font-size: 14px; color: #333; margin-bottom: 10px; }
        .post-badge { background: #E5F0FF; color: #0068FF; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        /* TAB B√ÅO C√ÅO */
        .camera-circle { width: 120px; height: 120px; background: white; border: 5px solid #0068FF; border-radius: 50%; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 50px; color: #0068FF; cursor: pointer; box-shadow: 0 5px 15px rgba(0,104,255,0.3); }
        .camera-circle:active { transform: scale(0.95); background: #f0f0f0; }
        
        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-around; padding: 8px 0; z-index: 1000; }
        .nav-item { text-align: center; color: #72808e; text-decoration: none; font-size: 10px; width: 33%; cursor: pointer; }
        .nav-item.active { color: #0068FF; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* Utility */
        .hidden { display: none !important; }
        #cameraInput { display: none; }
    </style>
</head>
<body>

    <div class="zalo-header">
        <div class="header-title">üèóÔ∏è C∆† GI·ªöI VI·ªÜT NAM</div>
        <div class="small opacity-75"><i class="bi bi-person-circle"></i> <span id="user-display">...</span></div>
    </div>

    <div class="content-area">
        
        <div id="tab-home">
            <div id="news-feed"></div>
            <h6 class="text-muted small fw-bold mt-4 ms-2">VI·ªÜC M·ªöI ƒêANG TUY·ªÇN üëá</h6>
            <div id="job-feed"></div>
        </div>

        <div id="tab-report" class="hidden text-center">
            <div class="zalo-card">
                <div id="gps-status" class="badge bg-warning text-dark mb-2">üì° ƒêang l·∫•y v·ªã tr√≠...</div>
                <h5 class="fw-bold text-primary">CH·ª§P ·∫¢NH HI·ªÜN TR∆Ø·ªúNG</h5>
                
                <div class="camera-circle" onclick="document.getElementById('cameraInput').click()">
                    <i class="bi bi-camera-fill"></i>
                </div>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="uploadPhoto()">

                <div id="preview-area" class="hidden mb-3">
                    <img id="preview-img" src="" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                    <div id="upload-msg" class="text-success fw-bold small mt-2">‚úÖ ·∫¢nh ƒë√£ l√™n m√¢y!</div>
                </div>

                <textarea id="note" class="form-control bg-light" rows="3" placeholder="Nh·∫≠p ghi ch√∫ c√¥ng vi·ªác..."></textarea>
                <div class="mt-3">
                    <select id="workerSelect" class="form-select mb-3"></select>
                    <button onclick="submitReport()" class="btn btn-primary w-100 fw-bold rounded-pill">G·ª¨I B√ÅO C√ÅO</button>
                </div>
            </div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="zalo-card d-flex align-items-center">
                <div class="post-avatar" style="width: 60px; height: 60px; font-size: 24px;">üë§</div>
                <div class="ms-3">
                    <div class="fw-bold fs-5" id="profile-name">...</div>
                    <div class="text-muted small">Nh√¢n vi√™n k·ªπ thu·∫≠t</div>
                </div>
            </div>
            
            <div class="zalo-card p-0 overflow-hidden">
                <div class="p-3 border-bottom d-flex justify-content-between" onclick="alert('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn')">
                    <span>üìÖ L·ªãch s·ª≠ l√†m vi·ªác</span> <i class="bi bi-chevron-right text-muted"></i>
                </div>
                <div class="p-3 border-bottom d-flex justify-content-between" onclick="alert('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn')">
                    <span>üí∞ B·∫£ng l∆∞∆°ng</span> <i class="bi bi-chevron-right text-muted"></i>
                </div>
                <div class="p-3 text-danger fw-bold text-center" onclick="logout()" style="cursor: pointer;">
                    <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                </div>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <i class="bi bi-house-door-fill nav-icon"></i> C√¥ng vi·ªác
        </div>
        <div class="nav-item" onclick="switchTab('report')">
            <i class="bi bi-camera-fill nav-icon"></i> B√°o c√°o
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
            <i class="bi bi-person-fill nav-icon"></i> C√° nh√¢n
        </div>
    </div>

    <script>
        // --- LOGIC H·ªÜ TH·ªêNG ---
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login.html';
        const userName = localStorage.getItem('user_name');
        document.getElementById('user-display').innerText = userName;
        document.getElementById('profile-name').innerText = userName;

        function logout() { if(confirm("ƒêƒÉng xu·∫•t nh√©?")) { localStorage.clear(); window.location.href='/login.html'; } }

        // --- CHUY·ªÇN TAB (GIAO DI·ªÜN) ---
        function switchTab(tabName) {
            // ·∫®n h·∫øt
            document.getElementById('tab-home').classList.add('hidden');
            document.getElementById('tab-report').classList.add('hidden');
            document.getElementById('tab-profile').classList.add('hidden');
            // B·ªè active menu
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            // Hi·ªán c√°i c·∫ßn hi·ªán
            document.getElementById('tab-'+tabName).classList.remove('hidden');
            // Active icon t∆∞∆°ng ·ª©ng
            const index = tabName === 'home' ? 0 : (tabName === 'report' ? 1 : 2);
            document.querySelectorAll('.nav-item')[index].classList.add('active');
        }

        // --- LOGIC TRANG HOME ---
        async function loadHomeData() {
            // Load Tin T·ª©c
            try {
                const resN = await fetch('/api/news'); const news = await resN.json();
                document.getElementById('news-feed').innerHTML = news.map(n => `
                    <div class="zalo-card">
                        <div class="post-header">
                            <div class="post-avatar">üîî</div>
                            <div><div class="post-name">Th√¥ng b√°o c√¥ng ty</div><div class="post-time">V·ª´a xong</div></div>
                        </div>
                        <div class="fw-bold mb-1">${n.title}</div>
                        <div class="post-content">${n.content}</div>
                    </div>`).join('');
            } catch(e){}

            // Load Vi·ªác L√†m
            try {
                const userId = JSON.parse(atob(token.split('.')[1])).id;
                const resJ = await fetch(`/api/jobs?worker_id=${userId}`); 
                const jobs = await resJ.json();
                document.getElementById('job-feed').innerHTML = jobs.map(j => {
                    const btn = j.applied > 0 ? `<button class="btn btn-secondary btn-sm w-100" disabled>ƒê√£ ƒëƒÉng k√Ω</button>` : `<button class="btn btn-primary btn-sm w-100" onclick="applyJob(${j.id})">ƒêƒÉng k√Ω ngay</button>`;
                    return `
                    <div class="zalo-card" style="border-left: 4px solid #0068FF;">
                        <div class="post-header mb-2">
                            <div class="post-avatar" style="background:#E5F0FF;">üíº</div>
                            <div><div class="post-name">${j.title}</div><div class="post-time">üìç ${j.location}</div></div>
                        </div>
                        <div class="post-content small">${j.description}</div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span class="post-badge">üí∞ ${j.salary}</span>
                            <div style="width: 100px;">${btn}</div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e){}
        }

        async function applyJob(jid) {
            if(!confirm("ƒêƒÉng k√Ω nh·∫≠n vi·ªác n√†y?")) return;
            const uid = JSON.parse(atob(token.split('.')[1])).id;
            await fetch('/api/apply', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({worker_id:uid, job_id:jid})});
            alert("ƒê√£ ƒëƒÉng k√Ω!"); loadHomeData();
        }

        // --- LOGIC TRANG B√ÅO C√ÅO ---
        let imgUrl = "", gps = "";
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                gps = `${p.coords.latitude},${p.coords.longitude}`;
                document.getElementById('gps-status').innerHTML = "‚úÖ ƒê√£ c√≥ v·ªã tr√≠";
                document.getElementById('gps-status').className = "badge bg-success";
            });
        }
        
        fetch('/api/workers').then(r=>r.json()).then(d=>{
            const sel = document.getElementById('workerSelect');
            d.forEach(w => sel.innerHTML += `<option value="${w.id}" ${w.name===userName?'selected':''}>${w.name}</option>`);
        });

        async function uploadPhoto() {
            const f = document.getElementById('cameraInput').files[0];
            if(!f) return;
            document.getElementById('preview-area').classList.remove('hidden');
            document.getElementById('preview-img').src = URL.createObjectURL(f);
            
            const fd = new FormData(); fd.append('photo', f);
            const res = await fetch('/api/upload', {method:'POST', body:fd});
            const d = await res.json();
            if(d.url) imgUrl = d.url;
        }

        async function submitReport() {
            if(!imgUrl || !gps) return alert("Thi·∫øu ·∫£nh ho·∫∑c GPS!");
            const note = document.getElementById('note').value;
            const wid = document.getElementById('workerSelect').value;
            const res = await fetch('/api/reports', {
                method:'POST', headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                body:JSON.stringify({worker_id:wid, location:gps, image_url:imgUrl, note:note})
            });
            if(res.ok) { alert("B√°o c√°o th√†nh c√¥ng!"); window.location.reload(); }
        }

        // Init
        loadHomeData();
    </script>
</body>
</html>
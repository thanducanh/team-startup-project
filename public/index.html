<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C∆† GI·ªöI VN</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèóÔ∏è</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* --- BI·∫æN M√ÄU ZALO --- */
        :root {
            --zalo-blue: #0068FF;
            --zalo-bg: #F4F5F7;
            --zalo-hover: #F1F1F1;
            --text-main: #000;
            --text-sub: #767676;
        }
        body { background-color: var(--zalo-bg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }

        /* ============================
           1. GIAO DI·ªÜN PC (Sidebar)
           ============================ */
        .sidebar-pc {
            width: 64px; background: var(--zalo-blue); position: fixed; top: 0; left: 0; height: 100vh;
            display: flex; flex-direction: column; align-items: center; padding-top: 24px; z-index: 2000;
        }
        .sidebar-icon {
            font-size: 24px; color: rgba(255,255,255,0.7); margin-bottom: 28px; cursor: pointer;
            transition: all 0.2s; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;
        }
        .sidebar-icon:hover { background: rgba(255,255,255,0.1); color: white; }
        .sidebar-icon.active { background: rgba(0,0,0,0.15); color: white; }

        /* V√πng n·ªôi dung ch√≠nh tr√™n PC */
        .main-container {
            margin-left: 64px; /* Ch·ª´a ch·ªó cho Sidebar */
            padding: 20px;
            max-width: 800px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông ƒë·ªÉ Feed kh√¥ng b·ªã b√® ra */
            margin-right: auto; /* CƒÉn gi·ªØa n·ªôi dung n·∫øu m√†n h√¨nh qu√° to */
        }

        /* ·∫®n Header/Nav c·ªßa Mobile ƒëi khi ·ªü tr√™n PC */
        .mobile-header, .mobile-bottom-nav { display: none !important; }

        /* ============================
           2. GIAO DI·ªÜN MOBILE (< 768px)
           ============================ */
        @media (max-width: 768px) {
            /* ·∫®n Sidebar PC */
            .sidebar-pc { display: none !important; }
            
            /* Reset l·ªÅ cho n·ªôi dung */
            .main-container { margin-left: 0; padding: 0; max-width: 100%; padding-top: 48px; padding-bottom: 60px; }

            /* Hi·ªán Header Mobile */
            .mobile-header {
                display: flex !important; background: var(--zalo-blue); height: 48px; padding: 0 16px;
                position: fixed; top: 0; width: 100%; z-index: 1000; align-items: center; justify-content: space-between;
            }
            .search-input-wrapper { background: rgba(255,255,255,0.25); border-radius: 8px; height: 32px; display: flex; align-items: center; padding: 0 10px; flex: 1; margin-right: 15px; }
            .search-input-wrapper input { background: transparent; border: none; color: white; font-size: 14px; width: 100%; outline: none; }
            .search-input-wrapper input::placeholder { color: rgba(255,255,255,0.7); }

            /* Hi·ªán Nav Bottom Mobile */
            .mobile-bottom-nav {
                display: flex !important; background: white; border-top: 1px solid #E0E0E0;
                height: 52px; position: fixed; bottom: 0; width: 100%; justify-content: space-around; align-items: center; z-index: 1000;
            }
            .nav-item { text-align: center; color: var(--text-sub); font-size: 10px; width: 25%; cursor: pointer; }
            .nav-item.active { color: var(--zalo-blue); }
            .nav-icon { font-size: 22px; display: block; margin-bottom: -2px; }
        }

        /* ============================
           3. C√ÅC COMPONENT CHUNG
           ============================ */
        
        /* CARD FEED & LIST */
        .feed-card { background: white; margin-bottom: 10px; padding: 15px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* PROFILE STYLE (Zalo Chu·∫©n) */
        .profile-header-card { background: white; padding: 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .profile-header-card:hover { background-color: var(--zalo-hover); }
        .avatar-circle { width: 50px; height: 50px; border-radius: 50%; background: #E1E4EA; color: #9FA7AB; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; border: 1px solid #eee; }
        
        .zalo-menu-group { background: white; margin-top: 8px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .zalo-menu-item { display: flex; align-items: center; padding: 14px 16px; cursor: pointer; transition: background 0.1s; position: relative; }
        .zalo-menu-item:hover { background-color: var(--zalo-hover); }
        .zalo-menu-item:active { background-color: #E8E8E8; }
        .zalo-menu-item:not(:last-child)::after { content: ''; position: absolute; bottom: 0; left: 56px; right: 0; height: 1px; background: #F4F5F7; }
        
        .menu-icon { width: 24px; font-size: 20px; margin-right: 16px; text-align: center; }
        .menu-text { font-size: 15px; color: var(--text-main); flex: 1; }
        .menu-sub { font-size: 13px; color: var(--text-sub); margin-right: 10px; }
        .menu-arrow { font-size: 14px; color: #BDBDBD; }

        /* POST MODAL (Zalo Style) */
        .zalo-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; flex-direction: column; }
        .zalo-modal-header { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #f0f0f0; }
        .btn-post { color: #87C6FF; font-weight: 600; font-size: 16px; background: none; border: none; }
        .btn-post.active { color: var(--zalo-blue); cursor: pointer; }
        
        .post-input-area { width: 100%; border: none; outline: none; font-size: 17px; resize: none; min-height: 150px; padding: 15px; }
        .post-tools { position: absolute; bottom: 0; width: 100%; border-top: 1px solid #f0f0f0; padding: 10px; display: flex; gap: 20px; font-size: 24px; color: var(--text-sub); }
        
        /* Camera Button */
        .camera-trigger { width: 70px; height: 70px; border: 3px solid var(--zalo-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--zalo-blue); margin: 20px auto; cursor: pointer; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <i class="bi bi-search text-white fs-5"></i>
        <div class="search-input-wrapper">
            <input type="text" placeholder="T√¨m ki·∫øm...">
        </div>
        <i class="bi bi-qr-code-scan text-white fs-5"></i>
    </div>

    <div class="sidebar-pc">
        <div style="font-size: 28px; margin-bottom: 30px; color: white;">üèóÔ∏è</div>
        
        <div class="sidebar-icon" onclick="switchTab('chat', this)" title="Tin nh·∫Øn"><i class="bi bi-chat-dots-fill"></i></div>
        <div class="sidebar-icon active" onclick="switchTab('home', this)" title="T∆∞·ªùng nh√†"><i class="bi bi-newspaper"></i></div>
        <div class="sidebar-icon" onclick="switchTab('report', this)" title="B√°o c√°o"><i class="bi bi-camera-fill"></i></div>
        <div class="sidebar-icon" onclick="switchTab('profile', this)" title="C√° nh√¢n"><i class="bi bi-person-fill"></i></div>
        
        <div class="sidebar-icon mt-auto mb-4" onclick="logout()" title="ƒêƒÉng xu·∫•t"><i class="bi bi-gear-fill"></i></div>
    </div>

    <div class="main-container">
        
        <div id="view-chat" class="hidden">
            <div class="bg-white p-3 border-bottom mb-2 fw-bold text-muted small">TIN NH·∫ÆN</div>
            <div id="contact-list" class="bg-white"></div>
        </div>

        <div id="view-home">
            <div class="feed-card d-flex align-items-center mb-2" onclick="openCreatePostModal()" style="cursor: pointer;">
                <div class="avatar-circle" style="width:36px;height:36px;font-size:16px;margin-right:10px;background:var(--zalo-blue);color:white;border:none;" id="feed-avatar-text">A</div>
                <div class="text-secondary flex-grow-1">B·∫°n ƒëang nghƒ© g√¨?</div>
                <i class="bi bi-images text-success fs-4"></i>
            </div>
            <div id="feed-container"></div>
        </div>

        <div id="view-report" class="hidden text-center">
            <div class="feed-card" style="min-height: 80vh; display:flex; flex-direction:column; justify-content:center;">
                <h5 class="fw-bold text-primary mb-3">B√ÅO C√ÅO C√îNG VI·ªÜC</h5>
                <div id="gps-status" class="badge bg-warning text-dark mb-3">üì° ƒêang ƒë·ªãnh v·ªã...</div>
                
                <div class="camera-trigger" onclick="document.getElementById('cameraInput').click()"><i class="bi bi-camera-fill"></i></div>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="uploadPhoto()" hidden>
                
                <div id="preview-area" class="hidden mt-3">
                    <img id="preview-img" src="" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                    <div class="text-success fw-bold small mt-2">‚úÖ ·∫¢nh ƒë√£ s·∫µn s√†ng</div>
                </div>

                <textarea id="note" class="form-control bg-light mt-3" rows="3" placeholder="Ghi ch√∫ c√¥ng vi·ªác..."></textarea>
                <button onclick="submitReport()" class="btn btn-primary w-100 fw-bold mt-3 rounded-pill">G·ª¨I B√ÅO C√ÅO</button>
            </div>
        </div>

        <div id="view-profile" class="hidden">
            <div class="profile-header-card" onclick="alert('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn')">
                <div class="avatar-circle"><i class="bi bi-person-fill"></i></div>
                <div class="flex-grow-1">
                    <h5 id="profile-name">...</h5>
                    <p>Xem trang c√° nh√¢n</p>
                </div>
                <i class="bi bi-arrow-clockwise refresh-icon" onclick="event.stopPropagation(); location.reload()"></i>
            </div>

            <div class="zalo-menu-group">
                <div class="zalo-menu-item">
                    <i class="bi bi-wallet2 menu-icon text-primary"></i>
                    <div class="menu-text">V√≠ QR</div>
                    <i class="bi bi-chevron-right menu-arrow"></i>
                </div>
                <div class="zalo-menu-item">
                    <i class="bi bi-cloud menu-icon text-info"></i>
                    <div class="menu-text">Cloud c·ªßa t√¥i</div>
                    <div class="menu-sub">230 MB / 1 GB</div>
                    <i class="bi bi-chevron-right menu-arrow"></i>
                </div>
            </div>

            <div class="zalo-menu-group">
                <div class="zalo-menu-item">
                    <i class="bi bi-shield-check menu-icon text-success"></i>
                    <div class="menu-text">T√†i kho·∫£n v√† b·∫£o m·∫≠t</div>
                    <i class="bi bi-chevron-right menu-arrow"></i>
                </div>
                <div class="zalo-menu-item">
                    <i class="bi bi-gear menu-icon text-secondary"></i>
                    <div class="menu-text">Quy·ªÅn ri√™ng t∆∞</div>
                    <i class="bi bi-chevron-right menu-arrow"></i>
                </div>
            </div>

            <div class="zalo-menu-group">
                <div class="zalo-menu-item" onclick="toggleLang()">
                    <i class="bi bi-translate menu-icon text-warning"></i>
                    <div class="menu-text">Ng√¥n ng·ªØ</div>
                    <div class="menu-sub" id="current-lang">Ti·∫øng Vi·ªát</div>
                    <i class="bi bi-chevron-right menu-arrow"></i>
                </div>
                <div class="zalo-menu-item" onclick="logout()">
                    <i class="bi bi-box-arrow-right menu-icon text-danger"></i>
                    <div class="menu-text text-danger fw-bold">ƒêƒÉng xu·∫•t</div>
                </div>
            </div>
        </div>

    </div>

    <div class="mobile-bottom-nav">
        <div class="nav-item" onclick="switchTab('chat', this)">
            <i class="bi bi-chat-dots-fill nav-icon"></i> Tin nh·∫Øn
        </div>
        <div class="nav-item active" onclick="switchTab('home', this)">
            <i class="bi bi-newspaper nav-icon"></i> T∆∞·ªùng nh√†
        </div>
        <div class="nav-item" onclick="switchTab('report', this)">
            <i class="bi bi-camera-fill nav-icon"></i> B√°o c√°o
        </div>
        <div class="nav-item" onclick="switchTab('profile', this)">
            <i class="bi bi-person-fill nav-icon"></i> C√° nh√¢n
        </div>
    </div>

    <div class="zalo-modal" id="createPostModal">
        <div class="zalo-modal-header">
            <i class="bi bi-x-lg" style="font-size:24px; cursor:pointer;" onclick="closeModal()"></i>
            <div class="fw-bold fs-5">T·∫°o b√†i vi·∫øt</div>
            <button class="btn-post" id="postBtn" disabled onclick="submitReport()">ƒêƒÇNG</button>
        </div>
        <div class="p-3">
            <div class="d-flex align-items-center mb-3">
                <div class="avatar-circle" style="width:40px;height:40px;margin-right:10px;font-size:20px;"><i class="bi bi-person-fill"></i></div>
                <div>
                    <div class="fw-bold" id="modal-name">...</div>
                    <div style="border:1px solid #ddd; border-radius:4px; padding:2px 6px; font-size:11px; display:inline-block; margin-top:2px;">C√¥ng khai ‚ñº</div>
                </div>
            </div>
            <textarea class="post-input-area" id="post-content" placeholder="B·∫°n ƒëang nghƒ© g√¨?" oninput="checkInput()"></textarea>
        </div>
        <div class="post-tools">
            <i class="bi bi-images text-success" onclick="document.getElementById('cameraInput').click()"></i>
            <i class="bi bi-person-plus-fill"></i>
            <i class="bi bi-geo-alt-fill text-danger"></i>
            <i class="bi bi-emoji-smile text-warning"></i>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if(!token) window.location.href = '/login.html';
        const myName = localStorage.getItem('user_name');
        
        // ƒêi·ªÅn t√™n v√†o c√°c v·ªã tr√≠
        document.getElementById('profile-name').innerText = myName;
        document.getElementById('modal-name').innerText = myName;
        document.getElementById('feed-avatar-text').innerText = myName.charAt(0);

        function logout() { if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.clear(); window.location.href='/login.html'; } }
        function toggleLang() { const el = document.getElementById('current-lang'); el.innerText = el.innerText==='Ti·∫øng Vi·ªát'?'English':'Ti·∫øng Vi·ªát'; }

        function switchTab(id, el) {
            document.querySelectorAll('#view-chat, #view-home, #view-report, #view-profile').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            
            // X·ª≠ l√Ω active cho c·∫£ 2 lo·∫°i menu
            document.querySelectorAll('.nav-item, .sidebar-icon').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            else {
                // Mapping index ƒë·ªÉ active t·ª± ƒë·ªông
                const idx = {'chat':0, 'home':1, 'report':2, 'profile':3}[id];
                if(document.querySelectorAll('.sidebar-icon')[idx]) document.querySelectorAll('.sidebar-icon')[idx].classList.add('active');
                if(document.querySelectorAll('.nav-item')[idx]) document.querySelectorAll('.nav-item')[idx].classList.add('active');
            }
        }

        // --- MODAL LOGIC ---
        function openCreatePostModal() { 
            document.getElementById('createPostModal').style.display = 'flex'; 
            // T·ª± ƒë·ªông l·∫•y GPS
            if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>{ gps=`${p.coords.latitude},${p.coords.longitude}`; });
        }
        function closeModal() { document.getElementById('createPostModal').style.display = 'none'; }
        function checkInput() {
            const val = document.getElementById('post-content').value;
            const btn = document.getElementById('postBtn');
            if(val.length > 0) btn.classList.add('active'), btn.disabled=false;
            else btn.classList.remove('active'), btn.disabled=true;
        }

        // --- DATA ---
        let imgUrl = "", gps = "";
        async function loadFeed() {
            const feed = document.getElementById('feed-container'); feed.innerHTML = '';
            try {
                const resN = await fetch('/api/news'); const news = await resN.json();
                news.forEach(n => feed.innerHTML += `<div class="feed-card"><div class="fw-bold text-primary mb-1">üì¢ ${n.title}</div><div>${n.content}</div></div>`);
                
                const uid = JSON.parse(atob(token.split('.')[1])).id;
                const resJ = await fetch(`/api/jobs?worker_id=${uid}`); const jobs = await resJ.json();
                jobs.forEach(j => {
                    const btn = j.applied > 0 ? `<span class="badge bg-secondary">ƒê√£ ·ª©ng tuy·ªÉn</span>` : `<button onclick="applyJob(${j.id})" class="btn btn-sm btn-outline-primary rounded-pill px-3">·ª®ng tuy·ªÉn</button>`;
                    feed.innerHTML += `<div class="feed-card" style="border-left:4px solid var(--zalo-blue)"><div class="d-flex justify-content-between"><div><b>üíº ${j.title}</b><div class="small text-muted">${j.location} ‚Ä¢ ${j.salary}</div></div>${btn}</div></div>`;
                });
            } catch(e){}
        }

        async function loadContacts() {
            const res = await fetch('/api/workers'); const users = await res.json();
            document.getElementById('contact-list').innerHTML = users.map(u => `
                <div class="profile-header-card" style="border-bottom:1px solid #eee">
                    <div class="avatar-circle" style="background:var(--zalo-blue);color:white;font-weight:bold;font-size:20px;width:45px;height:45px;margin-right:12px;">${u.name.charAt(0)}</div>
                    <div class="flex-grow-1"><div class="fw-bold" style="font-size:15px">${u.name}</div><div class="small text-muted">Truy c·∫≠p 1 ph√∫t tr∆∞·ªõc</div></div>
                    <i class="bi bi-telephone text-muted fs-5 me-3"></i><i class="bi bi-camera-video text-muted fs-5"></i>
                </div>`).join('');
        }

        // UPLOAD & SUBMIT (D√πng chung cho c·∫£ B√°o c√°o v√† Modal m·ªõi)
        async function uploadPhoto() {
            const f = document.getElementById('cameraInput').files[0]; if(!f) return;
            // X·ª≠ l√Ω preview
            document.getElementById('preview-img').src = URL.createObjectURL(f);
            document.getElementById('preview-area').classList.remove('hidden');
            
            const fd = new FormData(); fd.append('photo', f);
            const res = await fetch('/api/upload', {method:'POST',body:fd});
            const d = await res.json();
            if(d.url) { imgUrl = d.url; checkInput(); } // Enable n√∫t ƒëƒÉng ·ªü modal
        }

        async function submitReport() {
            // L·∫•y n·ªôi dung t·ª´ Modal ho·∫∑c Tab B√°o c√°o
            const note = document.getElementById('note').value || document.getElementById('post-content').value;
            const uid = JSON.parse(atob(token.split('.')[1])).id;
            
            if(!note && !imgUrl) return alert("Vi·∫øt g√¨ ƒë√≥ ho·∫∑c ƒëƒÉng ·∫£nh ƒëi b·∫°n ∆°i!");
            
            document.getElementById('postBtn').innerText = "ƒêANG G·ª¨I...";
            const res = await fetch('/api/reports', {
                method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
                body:JSON.stringify({worker_id:uid, location:gps, image_url:imgUrl, note:note})
            });
            if(res.ok) { alert("ƒêƒÉng b√†i th√†nh c√¥ng!"); window.location.reload(); }
        }

        async function applyJob(jid) { if(confirm('·ª®ng tuy·ªÉn?')) { const uid=JSON.parse(atob(token.split('.')[1])).id; await fetch('/api/apply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({worker_id:uid,job_id:jid})}); loadFeed(); } }

        loadFeed(); loadContacts();
    </script>
</body>
</html>
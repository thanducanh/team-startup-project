<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C∆† GI·ªöI VN | Nh√¢n vi√™n</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèóÔ∏è</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* M√ÄU ZALO CHU·∫®N M·ªöI: #0190f3 */
        body { background-color: #f4f5f7; font-family: 'Segoe UI', sans-serif; }
        
        /* --- C·∫§U TR√öC RESPONSIVE --- */
        /* PC */
        .sidebar { width: 80px; background: #0190f3; position: fixed; top: 0; left: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 1000; }
        .main-content { margin-left: 80px; padding: 20px; max-width: 1000px; }
        .mobile-header, .bottom-nav { display: none; }
        .sidebar-icon { font-size: 26px; color: rgba(255,255,255,0.7); margin-bottom: 30px; cursor: pointer; transition: 0.2s; }
        .sidebar-icon:hover, .sidebar-icon.active { color: white; transform: scale(1.1); }

        /* MOBILE */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; padding: 10px; margin-top: 60px; margin-bottom: 70px; }
            .mobile-header { display: flex; background: linear-gradient(90deg, #0190f3, #0078d4); color: white; padding: 10px 15px; position: fixed; top: 0; width: 100%; z-index: 1000; align-items: center; justify-content: space-between; height: 50px; }
            .bottom-nav { display: flex; position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; justify-content: space-around; padding: 8px 0; z-index: 1000; }
        }

        /* CSS CHUNG */
        .nav-item { text-align: center; color: #72808e; font-size: 10px; width: 25%; } /* Chia 4 c·ªôt */
        .nav-item.active { color: #0190f3; font-weight: bold; }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; }
        .search-bar { background: rgba(255,255,255,0.2); border: none; padding: 5px 15px; border-radius: 20px; color: white; width: 100%; font-size: 14px; }
        .feed-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .camera-btn { width: 70px; height: 70px; border: 4px solid #0190f3; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #0190f3; margin: 0 auto; cursor: pointer; }
        .contact-item { display: flex; align-items: center; padding: 15px; background: white; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
    </style>
</head>
<body>

    <div class="mobile-header">
        <input type="text" class="search-bar" placeholder="T√¨m ki·∫øm...">
        <i class="bi bi-qr-code-scan text-white ms-3 fs-5"></i>
    </div>

    <div class="sidebar">
        <div style="font-size: 30px; margin-bottom: 40px;">üèóÔ∏è</div>
        <div class="sidebar-icon" onclick="switchTab('chat', this)" title="Tin nh·∫Øn"><i class="bi bi-chat-dots-fill"></i></div>
        <div class="sidebar-icon active" onclick="switchTab('home', this)" title="T∆∞·ªùng nh√†"><i class="bi bi-newspaper"></i></div>
        <div class="sidebar-icon" onclick="switchTab('report', this)" title="B√°o c√°o"><i class="bi bi-camera-fill"></i></div>
        <div class="sidebar-icon" onclick="switchTab('profile', this)" title="C√° nh√¢n"><i class="bi bi-person-fill"></i></div>
        <div class="sidebar-icon mt-auto mb-4" onclick="logout()" title="ƒêƒÉng xu·∫•t"><i class="bi bi-box-arrow-right"></i></div>
    </div>

    <div class="main-content">
        
        <div id="view-chat" class="hidden">
            <h5 class="fw-bold text-secondary mb-3 d-none d-md-block">Tin nh·∫Øn</h5>
            <div class="feed-card p-0 overflow-hidden">
                <div class="contact-item" onclick="alert('T√≠nh nƒÉng chat ƒëang ph√°t tri·ªÉn!')">
                    <div style="width:50px;height:50px;background:#0190f3;color:white;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:bold;margin-right:15px;font-size:20px;">S</div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">S·∫øp T·ªïng (Admin)</div>
                        <div class="text-muted small">Vui l√≤ng b√°o c√°o ƒë√∫ng gi·ªù...</div>
                    </div>
                    <div class="text-muted small">Just now</div>
                </div>
                <div class="contact-item" onclick="alert('T√≠nh nƒÉng chat ƒëang ph√°t tri·ªÉn!')">
                    <div style="width:50px;height:50px;background:#ddd;color:#555;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:bold;margin-right:15px;font-size:20px;">K</div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">Ph√≤ng K·∫ø To√°n</div>
                        <div class="text-muted small">ƒê√£ nh·∫≠n b·∫£ng ch·∫•m c√¥ng th√°ng 12.</div>
                    </div>
                    <div class="text-muted small">1 gi·ªù</div>
                </div>
            </div>
        </div>

        <div id="view-home">
            <h5 class="fw-bold text-secondary mb-3 d-none d-md-block">T∆∞·ªùng nh√†</h5>
            <div class="feed-card d-flex align-items-center cursor-pointer" onclick="switchTab('report')">
                <div style="width:40px;height:40px;background:#0190f3;color:white;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:bold;margin-right:10px;" id="avatar-text">Me</div>
                <div class="text-muted flex-grow-1">H√¥m nay b·∫°n l√†m g√¨? B√°o c√°o ngay...</div>
                <i class="bi bi-images text-success fs-4"></i>
            </div>
            <div id="feed-container"></div>
        </div>

        <div id="view-report" class="hidden">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="feed-card text-center pb-4">
                        <h5 class="fw-bold text-primary mb-3">üì∏ B√ÅO C√ÅO C√îNG VI·ªÜC</h5>
                        <div id="gps-status" class="badge bg-warning text-dark mb-3">üì° ƒêang d√≤ v·ªã tr√≠...</div>
                        <div class="camera-btn" onclick="document.getElementById('cameraInput').click()"><i class="bi bi-camera-fill"></i></div>
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="uploadPhoto()" hidden>
                        <div id="preview-area" class="hidden mt-3">
                            <img id="preview-img" src="" style="width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                            <div class="text-success fw-bold small mt-2">‚úÖ ·∫¢nh ƒë√£ l√™n m√¢y!</div>
                        </div>
                        <textarea id="note" class="form-control bg-light mt-3" rows="3" placeholder="Ghi ch√∫ c√¥ng vi·ªác..."></textarea>
                        <button onclick="submitReport()" class="btn btn-primary w-100 fw-bold mt-3 rounded-pill py-2" style="background-color: #0190f3; border: none;">G·ª¨I B√ÅO C√ÅO</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-profile" class="hidden">
            <div class="feed-card d-flex align-items-center">
                <div style="width:60px;height:60px;background:#ddd;border-radius:50%;font-size:30px;display:flex;justify-content:center;align-items:center;">üë§</div>
                <div class="ms-3">
                    <div class="fw-bold fs-5" id="profile-name">...</div>
                    <div class="text-muted small">Nh√¢n vi√™n k·ªπ thu·∫≠t</div>
                </div>
            </div>
            <div class="feed-card p-0 overflow-hidden">
                <div class="p-3 border-bottom"><i class="bi bi-wallet2 text-primary me-2"></i> B·∫£ng l∆∞∆°ng</div>
                <div class="p-3 text-danger fw-bold" onclick="logout()" style="cursor:pointer"><i class="bi bi-box-arrow-right me-2"></i> ƒêƒÉng xu·∫•t</div>
            </div>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="switchTab('chat', this)"><i class="bi bi-chat-dots-fill nav-icon"></i> Tin nh·∫Øn</div>
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="bi bi-newspaper nav-icon"></i> T∆∞·ªùng nh√†</div>
        <div class="nav-item" onclick="switchTab('report', this)"><i class="bi bi-camera-fill nav-icon"></i> B√°o c√°o</div>
        <div class="nav-item" onclick="switchTab('profile', this)"><i class="bi bi-person-fill nav-icon"></i> C√° nh√¢n</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if(!token) window.location.href = '/login.html';
        const myName = localStorage.getItem('user_name');
        document.getElementById('avatar-text').innerText = myName.charAt(0);
        document.getElementById('profile-name').innerText = myName;

        function logout() { if(confirm("ƒêƒÉng xu·∫•t?")) { localStorage.clear(); window.location.href='/login.html'; } }

        function switchTab(id, el) {
            document.querySelectorAll('#view-chat, #view-home, #view-report, #view-profile').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item, .sidebar-icon').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            else {
                const map = {'chat':0, 'home':1, 'report':2, 'profile':3};
                if(document.querySelectorAll('.sidebar-icon')[map[id]]) document.querySelectorAll('.sidebar-icon')[map[id]].classList.add('active');
                if(document.querySelectorAll('.nav-item')[map[id]]) document.querySelectorAll('.nav-item')[map[id]].classList.add('active');
            }
        }

        // LOGIC DATA
        async function loadFeed() {
            const feed = document.getElementById('feed-container'); feed.innerHTML = '';
            try {
                const resN = await fetch('/api/news'); const news = await resN.json();
                news.forEach(n => feed.innerHTML += `<div class="feed-card"><div class="fw-bold text-primary mb-1">üì¢ ${n.title}</div><div class="small">${n.content}</div></div>`);
                const uid = JSON.parse(atob(token.split('.')[1])).id;
                const resJ = await fetch(`/api/jobs?worker_id=${uid}`); const jobs = await resJ.json();
                jobs.forEach(j => {
                    const btn = j.applied > 0 ? `<span class="badge bg-secondary">ƒê√£ ƒëƒÉng k√Ω</span>` : `<button onclick="applyJob(${j.id})" class="btn btn-sm btn-outline-primary rounded-pill px-3">ƒêƒÉng k√Ω</button>`;
                    feed.innerHTML += `<div class="feed-card" style="border-left:4px solid #0190f3"><div class="d-flex justify-content-between"><div><b>üíº ${j.title}</b><div class="small text-muted">${j.location} | ${j.salary}</div></div>${btn}</div></div>`;
                });
            } catch(e){}
        }

        let imgUrl = "", gps = "";
        if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>{gps=`${p.coords.latitude},${p.coords.longitude}`;document.getElementById('gps-status').className="badge bg-success";document.getElementById('gps-status').innerText="‚úÖ ƒê√£ c√≥ v·ªã tr√≠";});
        async function uploadPhoto() { const f=document.getElementById('cameraInput').files[0]; if(!f)return; document.getElementById('preview-img').src=URL.createObjectURL(f); document.getElementById('preview-area').classList.remove('hidden'); const fd=new FormData(); fd.append('photo', f); const res=await fetch('/api/upload',{method:'POST',body:fd}); const d=await res.json(); if(d.url) imgUrl=d.url; }
        async function submitReport() { if(!imgUrl||!gps) return alert('Thi·∫øu ·∫£nh ho·∫∑c GPS'); const note=document.getElementById('note').value; const uid=JSON.parse(atob(token.split('.')[1])).id; const res=await fetch('/api/reports',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify({worker_id:uid,location:gps,image_url:imgUrl,note:note})}); if(res.ok) { alert('Th√†nh c√¥ng!'); window.location.reload(); } }
        async function applyJob(jid) { if(confirm('ƒêƒÉng k√Ω?')) { const uid=JSON.parse(atob(token.split('.')[1])).id; await fetch('/api/apply',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({worker_id:uid,job_id:jid})}); loadFeed(); } }

        loadFeed();
    </script>
</body>
</html>